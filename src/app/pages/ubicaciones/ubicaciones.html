<h2 class="title">Ubicaciones</h2>

<div class="container" [formGroup]="form">
  <!-- Mensajes -->
  <div *ngIf="successMessage" class="msg msg-success">{{ successMessage }}</div>
  <div *ngIf="errorMessage" class="msg msg-error">{{ errorMessage }}</div>

  <section class="row controls">
    <div class="col">
      <label>País</label>
      <select (change)="onPaisChange()" formControlName="paisId">
        <option [ngValue]="null">Seleccione País</option>
        <option *ngFor="let p of paises" [ngValue]="p.id">{{ p.nombre }}</option>
      </select>
    </div>

    <div class="col">
      <label>Departamento</label>
      <select (change)="onDepartamentoChange()" formControlName="departamentoId">
        <option [ngValue]="null">Seleccione Departamento</option>
        <option *ngFor="let d of departamentosSelect" [ngValue]="d.id">{{ d.nombre }}</option>
      </select>
    </div>
  </section>

  <section class="cards">
    <div class="card">
      <h3>Crear País</h3>
      <input formControlName="nombrePais" placeholder="Nombre del país" autocomplete="off">
      <div class="actions">
        <button type="button" (click)="crearPais()" [disabled]="loadingPais || !form.get('nombrePais')?.value">Guardar</button>
        <span *ngIf="loadingPais" class="spinner" aria-hidden="true"></span>
      </div>
    </div>

    <div class="card">
      <h3>Crear Departamento</h3>
      <input formControlName="nombreDepartamento" placeholder="Nombre" autocomplete="off">
      <div class="actions">
        <button type="button" (click)="crearDepartamento()" [disabled]="loadingDepartamento || !form.get('paisId')?.value || !form.get('nombreDepartamento')?.value">Guardar</button>
        <span *ngIf="loadingDepartamento" class="spinner" aria-hidden="true"></span>
      </div>
    </div>

    <div class="card">
      <h3>Crear Ciudad</h3>
      <input formControlName="nombreCiudad" placeholder="Nombre" autocomplete="off">
      <div class="actions">
        <button type="button" (click)="crearCiudad()" [disabled]="loadingCiudad || !form.get('departamentoId')?.value || !form.get('nombreCiudad')?.value">Guardar</button>
        <span *ngIf="loadingCiudad" class="spinner" aria-hidden="true"></span>
      </div>
    </div>
  </section>


  <section class="table-section">
    <h3>Todos los registros</h3>

    <!-- FILTRO -->
    <div class="filter-row">
      <input formControlName="filter" placeholder="Filtrar" (input)="applyFilter()" autocomplete="off" />
      <button type="button" class="btn btn-clear" (click)="form.patchValue({ filter: '' }); applyFilter();">Limpiar</button>
    </div>

    <table class="data-table">
      <thead>
        <tr>
          <th>País</th>
          <th>Departamento</th>
          <th>Ciudad</th>
          <th>Acciones</th> 
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let r of tablaFiltered">
          <td>
            <img *ngIf="r.paisFlag" [src]="r.paisFlag" alt="flag" class="flag" style="width:24px;height:16px;vertical-align:middle;margin-right:8px;border:1px solid #ddd;">
            
            {{ r.paisNombre }}
          </td>
          <td>{{ r.departamentoNombre }}</td>
          <td>{{ r.ciudadNombre }}</td>
          <td class="row-actions">
            <button type="button" class="btn btn-edit" (click)="openEditWindow(r)">Editar</button>
            <button type="button" class="btn btn-danger" (click)="openDeleteWindow(r)">Eliminar</button>
          </td>
        </tr>
        <tr *ngIf="tablaFiltered.length === 0">
          <td colspan="4" class="empty">No se encontraron registros</td>
        </tr>
      </tbody>
    </table>
  </section>

  <!-- Modal embebido para editar -->
  <div class="modal-overlay" *ngIf="editModalOpen">
    <div class="modal">
      <h3>Editar Datos</h3>
      <form [formGroup]="editForm" class="modal-form">
        <label>País (id: {{ editIds.paisId }})</label>
        <input formControlName="paisNombre" />

        <label>Departamento (id: {{ editIds.departamentoId }})</label>
        <input formControlName="departamentoNombre" />

        <label>Ciudad (id: {{ editIds.ciudadId }})</label>
        <input formControlName="ciudadNombre" />

        <div class="modal-actions">
          <button type="button" class="btn btn-cancel" (click)="closeEditModal()">Cancelar</button>
          <button type="button" class="btn btn-edit" (click)="saveEdit()">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal embebido para eliminar, ahora con formulario y estilos mejorados -->
  <div class="modal-overlay" *ngIf="deleteModalOpen">
    <div class="modal" style="max-width: 420px;">
      <h3 style="margin-bottom: 18px;">Eliminar registro</h3>
      <form class="modal-form">
        <div class="delete-form-group">
          <label>País</label>
          <input [value]="deleteNames.paisNombre" readonly class="readonly-input" />
        </div>
        <button *ngIf="deleteIds.ciudadId" type="button" class="btn btn-warning" style="margin-bottom: 10px; width: 100%;" (click)="deleteOnly('ciudad')">
            Eliminar
          </button>
        <div class="delete-form-group">
          <label>Departamento</label>
          <input [value]="deleteNames.departamentoNombre" readonly class="readonly-input" />
        </div>
         <button *ngIf="deleteIds.departamentoId" type="button" class="btn btn-danger" style="margin-bottom: 10px; width: 100%;" (click)="confirmDeleteDepartamento()">
            Eliminar
          </button>
        <div class="delete-form-group">
          <label>Ciudad</label>
          <input [value]="deleteNames.ciudadNombre" readonly class="readonly-input" />
        </div>
        <button *ngIf="deleteIds.paisId" type="button" class="btn btn-danger" style="width: 100%;" (click)="confirmDeletePais()">
            Eliminar
          </button>
    
        <div *ngIf="deleteWarning" class="delete-warning" style="margin-top: 10px; color: #b71c1c; font-weight: bold;">
          {{ deleteWarning }}
        </div>
        <div class="modal-actions" style="margin-top: 18px;">
          <button type="button" class="btn btn-cancel" style="width: 100%;" (click)="closeDeleteModal()">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

<style>
/* Opcional: mejora visual para inputs readonly y botones */
.readonly-input {
  width: 100%;
  background: #f5f5f5;
  border: 1px solid #e0e0e0;
  color: #333;
  padding: 6px 10px;
  border-radius: 4px;
  margin-bottom: 8px;
  font-size: 15px;
}
.delete-form-group label {
  font-weight: 500;
  margin-bottom: 2px;
  display: block;
}
.delete-actions .btn {
  font-size: 15px;
}
.delete-warning {
  background: #fff3cd;
  border: 1px solid #ffeeba;
  padding: 8px 10px;
  border-radius: 4px;
}
</style>
</div>

<!--
  - Selecciona país/departmento para crear y listar ciudades.
  - Paneles para crear País, Departamento y Ciudad.
  - Tabla combinada que muestra país - departamento - ciudad con acciones de editar/eliminar.
  - La columna de país mostrará la bandera si está disponible (campo paisFlag).
-->